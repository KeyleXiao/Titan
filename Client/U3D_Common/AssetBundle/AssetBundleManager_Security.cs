/*******************************************************************
** 文件名:	AssetBundleManager.cs
** 版  权:	(C) 深圳冰川网络技术有限公司 2014 - Speed
** 创建人:	谭强均
** 日  期:	2015/10/26
** 版  本:	1.0
** 描  述:	ab资源管理器
** 应  用:  	ab资源管理器

**************************** 修改记录 ******************************
** 修改人: 
** 日  期: 
** 描  述: 
********************************************************************/
using UnityEngine;
using System.Collections;
using System.Collections.Generic;
using System;
using System.IO;
using System.Runtime.InteropServices;

public sealed partial class AssetBundleManager : MonoBehaviour
{

    const uint CRYPT_TYPE_1 = 0x2;
    static uint CRYPT_TYPE_MAP = CRYPT_TYPE_1;	/// 字节映射加密类型，对加密后进行的压缩损害小

    /// <summary>
    /// 资源包直接使用偏移
    /// </summary>
    static Byte[] AssetFileClassfiyKeyBytes = new Byte[] { 85,110,105,116,121,70,83,6,53,46,120,46,120,53,46,52,46,50,112,52,8,106,42,64,91,67,30,1,81,1,8,105,63,17,64,14,8,1,22,67,65,66,45,54,49,51,
                                                            48,49,48,49,50,50,54,51,49,50,50,49,49,52,49,49,50,49,50,57,56,49,48,54,48,49,53,51,49,52,50,49,48,49,53,49,48,56,49,52,48,63,4,63,105,63,16,
                                                            63,46,52,46,50,112,52,15,16,63,46,52,46,50,112,52,5,1,3,28,47,63,19,63,114,4,231,128,155,229,137,144,53,230,181,190,63,25,1,2,106,3,226,130,172,
                                                            55,226,130,172,239,163,181,239,163,181,239,163,181,239,163,181,226,130,172,1,1,72,3,226,130,172,63,226,130,172,239,163,181,239,163,181,239,163,181,
                                                            239,163,181,1,1,226,130,172,1,2,1,49,226,130,172,49,226,130,172,239,163,181,239,163,181,239,163,181,239,163,181,2,1,64,1,3,232,191,137,27,3,226,130,
                                                            172,4,3,1,1,3,81,226,130,172,106,226,130,172,1,4,1,1,1,232,191,137,4,5,16,1,1,232,191,137,8,4,6,16,1,1,232,191,137,17,4,7,16,1,1,232,191,137,37,4,8,
                                                            1,1,1,232,191,137,53,4,9,16,1,1,76,226,130,172,64,76,226,130,172,77,1,11,232,191,137,63,15,1,2,232,191,137,63,16,1,2,238,148,133,63,17,1,2,232,191,137,
                                                            63,18,1,1,232,191,137,63,19,1,1,232,191,137,63,20,1,1,1,126,3,226,130,172,63,239,163,181,239,163,181,239,163,181,21,1,64,1,2,232,191,137,27,3,226,130,
                                                            172,4,22,1,1,2,63,226,130,172,106,226,130,172,1,23,1,1,1,63,239,163,181,239,163,181,239,163,181,239,163,181,24,
                                                            226,130,172,1,2,63,226,130,172,63,226,130,172,27,3,226,130,172,4,26,1,2,72,3,226,130,172,20,1,49,226,130,172,239,163,181,239,163,181,239,163,181,239,163,
                                                            181,28,1,64,1,4,232,191,137,27,3,226,130,172,4,29,1,1,4,81,226,130,172,106,226,130,172,15,16,63,46,52,
                                                            46,50,112,52,5,1,3,28,47,63,19,63,114,4,231,128,155,229,137,144,53,230,181,190,63,25,1,2,106,3,226,130,172,55,226,130,172,239,163,181,239,163,181,239,163,
                                                            181,239,163,181,226,130,172,1,1,72,3,226,130,172,63,226,130,172,239,163,181,239,163,181,239,163,181,239,163,181,1,1,226,130,172,1,2,1,49,226,130,172,49,226,
                                                            130,172,239,163,181,239,163,181,239,163,181,239,163,181,2,1,64,1,3,232,191,137,27,3,226,130,172,4,3,1,1,3,81,226,130,172,106,226,130,172,1,4,1,1,1,232,191,137,
                                                            4,5,16,1,1,232,191,137,8,4,6,16,1,1,232,191,137,17,4,7,16,1,1,232,191,137,37,4,8,1,1,1,232,191,137,53,4,9,16,1,1,76,226,130,172,64,76,226,130,172,77,1,11,232,
                                                            191,137,63,15,1,2,232,191,137,63,16,1,2,238,148,133,63,17,1,2,232,191,137,63,18,1,1,232,191,137,63,19,1,1,232,191,137,63,20,1,1,1,126,3,226,
                                                            130,172,63,239,163,181,239,163,181,239,163,181,21,1,64,1,2,232,191,137,27,3,226,130,172,4,22,1,1,2,63,226,130,172,106,226,130,172,1,23,1,1,1,63,239,163,181,239,
                                                            163,181,239,163,181,239,163,181,24,226,130,172,1,2,63,226,130,172,63,226,130,172,27,3,226,130,172,4,26,1,2,72,3,226,130,172,20,1,49,226,130,172,239,163,181,239,
                                                            163,181,239,163,181,239,163,181,28,1,64,1,4,232,191,137,27,3,226,130,172,4,29,1,1,4,81,226,130,172,106,226,130,172,1,109,95,70,105,108,101,73,68,109,95,80,97,116,
                                                            104,73,68,109,95,76,111,99,97,108,82,111,116,97,116,105,111,110,120,121,122,119,109,95,76,111,99,97,108,80,111,115,105,116,105,111,110,109,95,76,111,99,97,108,83,
                                                            99,97,108,101,109,95,67,104,105,108,100,114,101,110,109,95,70,97,116,104,101,114,43,116,229,153,131,78,119,230,144,156,230,
                                                            163,175,233,171,169,229,147,133,
                                                            85,110,105,116,121,70,83,6,53,46,120,46,120,53,46,52,46,50,112,52,8,106,42,64,91,67,30,1,81,1,8,105,63,17,64,14,8,1,22,67,65,66,45,49,48,49,53,51,55,49,49,51,50,57,
                                                            54,57,51,49,53,55,54,49,52,49,48,52,50,49,52,49,53,49,48,49,48,49,48,50,49,49,49,50,54,48,53,51,49,49,49,63,4,63,105,63,16,63,46,52,46,50,112,52,15,16,63,46,52,46,
                                                            50,112,52,5,1,3,28,47,63,19,63,114,4,231,128,155,229,137,144,53,230,181,190,63,25,1,2,106,3,226,130,172,55,226,130,172,239,163,181,239,163,181,239,163,
                                                            181,239,163,181,226,130,172,1,1,72,3,226,130,172,63,226,130,172,239,163,181,239,163,181,239,163,181,239,163,181,1,1,226,130,172,1,2,1,49,226,130,172,49,226,130,172,
                                                            239,163,181,239,163,181,239,163,181,239,163,181,2,1,64,1,3,232,191,137,27,3,226,130,172,4,3,1,1,3,81,226,130,172,106,226,130,172,1,4,1,1,1,232,191,137,4,5,16,1,1,232,
                                                            191,137,8,4,6,16,
                                                            1,1,232,191,137,17,4,7,16,1,1,232,191,137,37,4,8,1,1,1,232,191,137,53,4,9,16,1,1,76,226,130,172,64,76,226,130,172,77,1,11,232,191,137,63,15,1,2,232,191,137,63,16,1,
                                                            2,238,148,133,63,17,1,2,232,191,137,63,18,1,1,232,191,137,63,19,1,1,232,191,137,63,20,1,1,1,126,3,226,130,172,63,239,163,181,239,163,181,239,163,181,21,1,64,1,2,232,191,137,27,3,226,130,172,4,22,1,
                                                            1,2,63,226,130,172,106,226,130,172,1,23,1,1,1,63,239,163,181,239,163,181,239,163,181,239,163,181,24,226,130,172,1,2,63,226,130,172,63,226,130,172,27,3,226,130,172,4,26,
                                                            1,2,72,3,226,130,172,20,1,49,226,130,
                                                            172,239,163,181,239,163,181,239,163,181,239,163,181,28,1,64,1,4,232,191,137,27,3,226,130,172,4,29,1,1,4,81,226,130,172,106,226,130,172,15,16,63,46,52,46,50,112,52,
                                                            5,1,3,28,47,63,19,63,114,4,231,128,155,229,137,144,53,
                                                            230,181,190,63,25,1,2,106,3,226,130,172,55,226,130,172,239,163,181,239,163,181,239,163,181,239,163,181,226,130,172,1,1,72,3,226,130,172,63,226,130,172,239,163,181,
                                                            239,163,181,239,163,181,239,163,181,1,1,226,130,172,1,2,1,49,226,130,172,49,226,
                                                            130,172,239,163,181,239,163,181,239,163,181,239,163,181,2,1,64,1,3,232,191,137,27,3,226,130,172,4,3,1,1,3,81,226,130,172,106,226,130,172,1,4,1,1,1,232,191,137,4,
                                                            5,16,1,1,232,191,137,8,4,6,16,1,1,232,191,137,17,4,7,16,1,1,232,191,137,37,4,8,1,1,1,232,191,137,53,4,9,16,1,1,76,226,130,172,64,76,226,130,172,77,1,11,232,191,137,
                                                            63,15,1,2,232,191,137,63,16,1,2,238,148,133,63,17,1,2,232,191,137,63,18,1,1,232,191,137,63,
                                                            19,1,1,232,191,137,63,20,1,1,1,126,3,226,130,172,63,239,163,181,239,163,181,239,163,181,21,1,64,1,2,232,191,137,27,3,226,130,172,4,22,1,1,2,63,226,130,172,106,226,
                                                            130,172,1,23,1,1,1,63,239,163,181,239,163,181,239,163,181,239,163,181,24,226,130,172,1,2,63,
                                                            226,130,172,63,226,130,172,27,3,226,130,172,4,26,1,2,72,3,226,130,172,20,1,49,226,130,172,239,163,181,239,163,181,239,163,181,239,163,181,28,1,64,1,4,232,191,137,27,3,
                                                            226,130,172,4,29,1,1,4,81,226,130,172,106,226,130,172,109,95,70,105,108,101,73,68,109,95,80,97,116,104,73,68,110,73,68,101,86,111,99,97,116,105,111,110,115,116,114,68,101,115,99,98,71,108,83,99,
                                                            97,108,101,98,73,103,110,111,114,101,83,105,110,103,108,101,69,102,102,101,99,116,79,112,116,105,109,116,105,122,101,100,69,110,97,98,108,101,68,105,115,116,97,110,99,101,79,112,116,105,109,116,105,122,
                                                            101,100,67,108,111,115,101,87,104,101,110,68,101,97,
                                                            85,110,105,116,121,70,83,6,53,46,120,46,120,53,46,52,46,50,112,52,8,106,42,64,91,67,30,1,81,1,8,105,63,17,64,14,8,1,22,67,65,66,45,49,51,57,49,52,50,50,54,49,49,54,
                                                            57,56,49,49,51,49,49,51,49,51,49,53,49,49,50,50,52,49,50,49,49,49,52,53,49,57,56,49,50,54,53,51,63,4,63,105,63,16,63,46,52,46,50,112,52,15,16,63,46,52,46,50,112,52,
                                                            5,1,3,28,47,63,19,63,114,4,231,128,155,229,137,144,53,230,181,190,63,25,1,2,106,3,226,130,172,55,226,130,172,239,163,181,239,163,181,239,163,181,239,163,181,226,130,172,1,
                                                            1,72,3,226,130,172,63,226,130,172,239,163,181,239,163,181,239,163,181,239,163,181,1,1,226,130,172,1,2,1,49,226,130,172,49,226,130,172,239,163,181,239,163,181,239,163
                                                            ,181,239,163,181,2,1,64,1,3,232,191,137,27,3,226,130,172,4,3,1,1,3,81,226,130,172,106,226,130,172,1,4,1,1,1,232,191,137,4,5,16,1,1,232,191,137,8,4,6,16,1,1,232,191,
                                                            137,17,4,7,16,1,1,232,191,137,37,4,8,1,1,1,232,191,137,53,4,9,16,1,1,76,226,130,172,64,76,226,130,172,77,1,11,232,191,137,63,15,1,2,232,191,137,63,16,1,2,238,148,
                                                            133,63,17,1,2,232,191,137,63,18,1,1,232,191,137,63,19,1,1,232,191,137,63,20,1,1,1,126,3,226,130,172,63,239,163,181,239,163,181,239,163,181,21,1,64,1,2,232,191,137,
                                                            27,3,226,130,172,4,22,
                                                            1,1,2,63,226,130,172,106,226,130,172,1,23,1,1,1,63,239,163,181,239,163,181,239,163,181,239,163,181,24,226,130,172,1,2,63,226,130,172,63,226,130,172,27,3,226,130,172,
                                                            4,26,1,2,72,3,226,130,172,20,1,49,226,130,172,239,163,181,239,163,181,239,163,181,239,163,
                                                            181,28,1,64,1,4,232,191,137,27,3,226,130,172,4,29,1,1,4,81,226,130,172,106,226,130,172,15,16,63,46,52,46,50,112,52,5,1,3,28,47,63,19,63,114,4,231,128,155,229,137,
                                                            144,53,230,181,190,63,25,1,2,106,3,226,130,172,55,226,130,172,239,163,181,239,163,181,239,163,181,239,163,181,226,130,172,1,1,72,3,226,130,172,63,226,130,172,239,
                                                            163,181,239,163,181,239,163,181,239,163,181,1,1,226,130,172,1,2,1,49,226,130,172,49,226,130,172,239,163,181,239,163,181,239,163,181,239,163,181,2,1,64,1,3,232,191,
                                                            137,27,3,226,130,172,4,3,1,1,3,81,226,130,172,106,226,130,172,1,4,1,1,1,232,191,137,4,5,16,1,1,232,191,137,8,4,6,16,1,1,232,191,137,17,4,7,16,1,1,232,191,137,37,4,
                                                            8,1,1,1,232,191,137,53,4,9,16,1,1,76,226,130,172,64,76,226,130,172,77,1,11,232,191,137,63,15,1,2,232,191,137,63,16,1,
                                                            2,238,148,133,63,17,1,2,232,191,137,63,18,1,1,232,191,137,63,19,1,1,232,191,137,63,20,1,1,1,126,3,226,130,172,63,239,163,181,239,163,181,239,163,181,21,1,64,1,2,
                                                            232,191,137,27,3,226,130,172,4,22,1,1,2,63,226,130,172,106,226,130,172,1,23,1,1,1,63,239,163,181,239,163,181,239,163,181,239,163,181,24,226,130,172,1,2,63,226,130,
                                                            172,63,226,130,172,27,3,226,130,172,4,26,1,2,72,3,226,130,172,20,1,49,226,130,172,239,163,181,239,163,181,239,163,181,239,163,181,28,1,64,1,4,232,191,137,27,3,226,
                                                            130,172,4,29,1,1,4,81,226,130,172,106,226,130,172,65,117,100,105,111,67,108,105,112,109,95,76,111,97,100,84,121,112,101,109,95,67,104,97,110,110,101,83,97,109,112,
                                                            108,101,109,95,76,101,110,103,116,104,109,95,73,115,84,114,97,99,107,101,114,70,111,114,109,97,116,109,95,83,117,98,115,111,117,110,100,73,110,100,101,120,109,95,
                                                            80,114,101,108,111,97,100,65,117,100,105,111,68,97,116,97,109,95,76,111,97,100,73,110,66,97,99,107,103,114,111,117,110,100,109,95,};

    /// <summary>
    /// 资源配置加密Key，暂时写死
    /// </summary>
    static uint AssetsConfigClassfiyKey = 0x7BD9E638;
    private static string DeCodeAssetFile(string filePath)
    {
        if (!File.Exists(filePath))
        {
            return string.Empty;
        }

        if (Application.isEditor && !ForceOpenDeCode)
        {
            return System.IO.File.ReadAllText(filePath);
        }

        Byte[] dataArray = System.IO.File.ReadAllBytes(filePath);
        //C#会将UTF8补齐到四个字节，C++的不会，所以在取的时候，再头部会多出一个字节
        string reslut = System.Text.UTF8Encoding.UTF8.GetString(DeCodeAssetConfigByte(dataArray));
        reslut = reslut.Remove(0, 1);
        return reslut;
    }

    private static Byte[] DeCodeAssetConfigByte(Byte[] source)
    {
        if (null == source)
        {
            return source;
        }
        IntPtr memory = Marshal.AllocHGlobal(source.Length);
        if (memory == IntPtr.Zero)
        {
            Debug.LogError("分配加密内存失败!-IntPtr.Zero");
            return source;
        }

        Marshal.Copy(source, 0, memory, source.Length);

        if (DecryptData(memory, (uint)source.Length, AssetsConfigClassfiyKey, CRYPT_TYPE_MAP) == 0)
        {
            Debug.LogError("分配加密内存失败!-DecryptData");
            return source;
        }

        Marshal.Copy(memory, source, 0, source.Length);

        Marshal.FreeHGlobal(memory);

        for (int i = 0; i < source.Length; i++)
        {
            source[i] ^= 3;
        }
        return source;
    }

    private static int DecryptData(IntPtr address, uint len, uint key, uint mask)
    {
        if(Application.isEditor)
        {
            if(IntPtr.Size == 8)
            {
                return DecryptData_Editor64(address, len, key);
            }
            return DecryptData_Editor32(address, len, key);
        }

        return DecryptData_RunTime(address,len,key);
    }

    [DllImport("mono_editor64.dll", EntryPoint = "decryptConfigData")]
    public extern static int DecryptData_Editor64(IntPtr address, uint len, uint key);

    [DllImport("mono_editor.dll", EntryPoint = "decryptConfigData")]
    public extern static int DecryptData_Editor32(IntPtr address, uint len, uint key);

    [DllImport("mono.dll", EntryPoint = "decryptConfigData")]
    public extern static int DecryptData_RunTime(IntPtr address, uint len, uint key);
}
